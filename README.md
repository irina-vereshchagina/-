# «Собутыльники» — продуктовая спецификация

## 0. Цель продукта
Поиск единомышленников поблизости для «душевных посиделок» и мини-вечеринок через механику свайпов, карту «живых точек» и систему репутации с упором на юмор, безопасность и доверие.

## 1. Объём MVP (версия 1.0)
### Пользовательский функционал
- **Регистрация и онбординг**: авторизация по телефону с подтверждением SMS, проверка возраста 18+ (KYC-lite), настройка ника и аватара.
- **Профиль**: поля возраста, пола (опционально), любимого напитка, списков «что есть у меня дома» и «что принесёшь ты», тем для разговора, 1–5 фотографий и настроения.
- **Геолокация**: точность до 500 м, опция видимости и невидимости, расширенные настройки радиуса в Pro.
- **Свайпы**: лента по расстоянию, карточка с ключевыми полями, лайк/скип, матчи и чат внутри матча.
- **Фильтры**: возрастные коридоры (18–25, 26–35, 36–45, 46+), тип вечера (тихо, настолки, бар-тур, пати), напиток.
- **Отзывы**: чекбоксы-реакции, шкалы 1–5 (душевность, адекватность, бодрость), опциональный комментарий.
- **Рейтинг и бейджи**: базовые бейджи за активности и локальный «Собутыльник недели».
- **Карта**: пины статусов «готов(а) посидеть» и «лучшие места» (UGC + модерация).
- **Безопасность**: кнопка SOS, «трезвый режим», напоминание «утром стыдно».
- **Монетизация PROSECCO**: первое сообщение без матча, кто смотрел профиль, расширенный радиус, режим инкогнито.

### Админка
- Модерация профилей, фотографий, отзывов и пользовательских точек.
- Управление банами, теневыми банами и их причинами.
- Настройка промокодов и фича-флагов.

## 2. Нефункциональные требования
- **Платформы**: iOS и Android (React Native/Flutter), Backend на Node.js/TypeScript или Go, PostgreSQL + PostGIS, Redis, AWS/GCP, CDN CloudFront/Cloudflare.
- **Масштабируемость**: старт на 10k DAU, горизонтальное масштабирование через Kubernetes/Autoscaling.
- **Производительность**: SLA API P95 < 250 мс, для матчмейкинга ≤ 500 мс.
- **Наблюдаемость**: OpenTelemetry, Prometheus/Grafana, Sentry для мобайла и админки.
- **Безопасность данных**: гео через PostGIS, округление координат, шифрование PII в хранении и при передаче.
- **Возрастной контроль**: KYC-lite через интегрированный SDK.

## 3. Высокоуровневая архитектура
Мобайл-клиенты → API Gateway → сервисы: auth, profile, match, chat (WebSocket), review/reputation, map/places, billing, moderation, notification, analytics. Очереди событий в Kafka/PubSub: `swipe`, `match_created`, `chat_msg`, `review_added`. Фича-флаги через ConfigCat/Unleash.

## 4. Модель данных (PostgreSQL + PostGIS)
- `users`: id, phone_hash, age, gender, created_at, status, is_pro, kyc_status.
- `profiles`: user_id (PK), nickname, bio, favorite_drink, have_at_home jsonb[], bring_with_you jsonb[], talk_topics jsonb[], photos jsonb[], mood_tags jsonb[].
- `locations`: user_id (PK), geom geography(Point,4326), city, last_seen_at, visibility_mode, search_radius_m.
- `swipes`: id, swiper_id, target_id, direction (`like`/`pass`), created_at.
- `matches`: id, user_a, user_b, created_at, is_active.
- `messages`: id, match_id, sender_id, text, attachments jsonb, created_at.
- `reviews`: id, reviewer_id, reviewee_id, meeting_at, scales jsonb, flags jsonb, comment, created_at.
- `reputation`: user_id (PK), avg_warmth, avg_sanity, avg_stamina, badges jsonb[], score float.
- `places`: id, creator_id, type (`ready_now`, `best_spot`, `home_party`), title, desc, geom, media jsonb[], status, created_at.
- `abuse_reports`: id, reporter_id, target_type (`user`, `place`, `review`, `message`), target_id, reason, created_at, status.
- `payments`: id, user_id, provider, product_id, amount, currency, status, started_at, confirmed_at.
- `audit_logs`: id, actor_type (`user`, `admin`, `system`), actor_id, action, payload jsonb, created_at.

## 5. API (REST + WebSocket)
### Аутентификация
- `POST /v1/auth/request_code` → `{phone}` → `{request_id}`
- `POST /v1/auth/verify_code` → `{request_id, code}` → `{access_token, refresh_token}`
- `POST /v1/auth/refresh` → `{refresh_token}` → `{access_token}`

### Профиль и локация
- `GET /v1/me` — профиль и репутация.
- `PUT /v1/me` — частичное обновление.
- `PUT /v1/me/photos` — загрузка через S3 pre-signed URL.
- `PUT /v1/me/location` — `{lat, lon, visibility_mode, search_radius_m}`.
- `GET /v1/users/{id}` — публичный профиль.

### Свайпы и лента
- `GET /v1/feed` — карточки `{user_id, distance, overlap_tags}` с фильтрами по возрасту, напитку, типу вечера, темам.
- `POST /v1/swipes` — `{target_id, direction}`.
- `GET /v1/matches` — список матчей.
- `POST /v1/matches/{id}/close` — закрытие матча.

### Чат
- WebSocket `/ws/chat?token=...`.
- `GET /v1/matches/{id}/messages?before=&limit=`.
- `POST /v1/matches/{id}/messages` — `{text|attachment}`.

### Отзывы и репутация
- `POST /v1/reviews` — `{reviewee_id, meeting_at, scales, flags, comment}`.
- `GET /v1/reviews/{user_id}` — агрегаты и последние 5 отзывов.
- `GET /v1/reputation/{user_id}` — `{score, badges[]}`.

### Карта и места
- `GET /v1/places/nearby?lat=&lon=&radius=&type=`.
- `POST /v1/places` (Pro/вериф.) — `{type, title, desc, lat, lon, media[]}`.
- `PUT /v1/places/{id}/status` — `{active|hidden|blocked}`.

### Подписка и платежи
- `GET /v1/billing/products` — список продуктов.
- `POST /v1/billing/purchase` — `{product_id, platform_receipt}`.
- `GET /v1/billing/status` — `{is_pro, expires_at}`.

### Репорты и модерация
- `POST /v1/report` — жалоба.
- `GET /v1/admin/moderation/queue` — очередь модерации.
- `POST /v1/admin/moderation/resolve` — решение по объекту.

#### Пример ответа `/v1/feed`
```json
{
  "items": [
    {
      "user_id": "u_123",
      "nickname": "Антон",
      "distance_m": 320,
      "favorite_drink": "просекко",
      "tags": ["настолки", "котики"],
      "preview_photos": ["https://..."],
      "reputation": {
        "score": 4.6,
        "badges": ["Душа компании"]
      }
    }
  ],
  "next_page": "eyJvZmZzZXQiOi0tL..."
}
```

## 6. Матчмейкинг и рекомендации
- Сортировка: расстояние → репутационный скор → совпадение тегов (напиток, темы, тип вечера).
- Негативные сигналы: множественные игноры и репорты снижают показ.
- Анти-эхо: кулдаун повторных показов.
- Сплит-тесты (через фича-флаг): вес репутации 20/40/60%.

## 7. Геймификация и бейджи
- Триггеры: `first_match`, `first_review_received`, `three_nights_no_sleep`, `met_ex` (скрытый).
- «Счётчик бутылок»: агрегируется из отзывов (`meeting_at`) и команды `/bottle +1` в чате.

## 8. Безопасность, антиабьюз и этика
- Обязательный KYC-lite (селфи + документ) с фича-флагом по регионам.
- Напоминания о разумном потреблении.
- «Трезвый режим» — видимость «просто пообщаться».
- Модерация отзывов и контента, чёрный список слов.
- SOS: быстрый доступ к экстренным контактам, отправка координат доверенному контакту.
- Приватность гео: округление и квантование координат (200–500 м).
- Vision+LLM модерация фото, био и сообщений.
- Репутация: отображаются агрегаты и мемные бейджи без прямой негативной огласки.

## 9. Подписка PROSECCO
- **Права**: до 3 первых сообщений без матча в сутки, список «кто смотрел» (агрегировано и отложено), расширенный радиус и фильтр «район/город», режим «анонимного запоя» без отображения онлайн.
- **Продукты**: `pro_week`, `pro_month`, `pro_year`, промо-период 7 дней (через фича-флаг).

## 10. Админка (MVP)
- Авторизация через SSO/OAuth.
- Очередь модерации с карточками пользователей, фото, отзывов и мест; действия «одобрить/скрыть/бан».
- Поиск по телефону, нику или ID.
- Просмотр репортов и журнала аудита.
- Управление фича-флагами и промокодами.

## 11. Уведомления
- Push: новый матч, сообщение, отзыв, бейдж «Собутыльник недели», напоминание «утром стыдно».
- Email/SMS (fallback): восстановление доступа, биллинг, KYC.
- Анти-спам: частотные лимиты, окна «не беспокоить».

## 12. Аналитика
- **События**: `auth_code_requested`, `auth_verified`, `profile_completed`, `photo_uploaded`, `location_updated`, `visibility_changed`, `feed_impression`, `card_view`, `swipe_like`, `swipe_pass`, `match_created`, `chat_opened`, `message_sent`, `review_submitted`, `reputation_updated`, `place_created`, `place_join_clicked`, `purchase_started`, `purchase_success`, `purchase_fail`, `sos_opened`, `sober_mode_enabled`.
- **Пользовательские свойства**: `age_bucket`, `city`, `is_pro`, `rep_score_bucket`.
- **Инструменты**: выгрузка в BigQuery/Snowflake, продуктовая аналитика в Amplitude/Mixpanel.

## 13. UX-флоу и критерии приёмки
1. **Регистрация**: телефон → код → соглашения → KYC later (ограниченный доступ) → онбординг (напиток, темы, 2 фото, гео). Код приходит, токен валиден, гео запрашивается однократно.
2. **Свайпы**: лента ~20 карточек, лайк/скип, при матче — экран «Матч!». Карточки релевантны фильтрам, P95 ответа < 500 мс.
3. **Чат**: вход в чат, отправка текста/фото. WebSocket подключается < 2 с, сообщения доставляются минимум один раз, вложения проходят модерацию.
4. **Отзыв**: пуш после встречи, форма сохраняет данные, репутация агрегируется ≤ 5 с, публичны только агрегаты.
5. **Карта**: статус «готов сейчас» размещает пин на 2 часа, приватность радиуса соблюдена.
6. **PRO**: успешная покупка, сообщение без матча с учётом лимита, статус синхронизируется со стором.

## 14. Тест-план
- Unit: auth/match/chat/review сервисы.
- Интеграционные: профиль, матчи, платежи (sandbox).
- Нагрузка: лента 200 RPS, чат 5k одновременных WebSocket-сессий.
- Безопасность: перехват токенов, SSRF, ограничение S3 pre-signed URL, rate limits.
- QA iOS/Android: пермишены, бэкграунд, убитый процесс, холодный старт.

## 15. Roadmap
- **M1 (4–6 недель)**: Auth, профиль, гео, лента/свайпы, матчи/чат, фильтры, биллинг, базовая модерация, аналитика.
- **M2 (3–4 недели)**: отзывы/репутация, карта «готов сейчас», бейджи, SOS/«утром стыдно», админка v1.
- **M3 (3–4 недели)**: KYC-lite, расширенная карта, анти-ghosting PRO, AI-рекомендации, улучшения антиабьюза.

## 16. Зависимости и интеграции
SMS (Twilio/Infobip), Push (FCM/APNS), хранение (S3 + CloudFront), биллинг (StoreKit/Google Billing + серверная валидация), KYC SDK (Onfido/Sumsub и др.).

## 17. Риски и смягчения
- Контент 18+: строгая модерация, жалобы, KYC.
- Оффлайн-безопасность: SOS, доверенные контакты, агрегированная локация.
- Абьюз/спам: лимиты первых сообщений, капчи, поведенческие сигналы, теневой бан.
- Приватность: округление координат, опция скрыть район.

## 18. План работ по командам
### Backend
- Скелет сервисов (auth, profile, match, chat, review, map, billing).
- Миграции БД, PostGIS.
- JWT + ротация refresh, RBAC.
- Файловый аплоад (S3 presign) с модерацией.
- Гео-выдача `/v1/feed` с сортировкой и фильтрами.
- WebSocket-чат (комнаты по `match_id`, подтверждения доставки).
- Отзывы и агрегация репутации (воркер очередей).
- Платежи: валидация квитанций, вебхуки.
- Нотификации: темы `match_*`, `chat_*`, `review_*`.

### Mobile (React Native/Flutter)
- Онбординг (телефон → код → профиль → гео).
- Редактор профиля, загрузка фото, пресеты тем и напитков.
- Свайпы с анимацией, карточки, быстрые теги.
- Матчи и чат (онлайн-статус, вложения, репорты).
- Фильтры/поиск.
- Экраны отзывов и бейджей.
- Карта «готов сейчас» и тумблер статуса.
- Экран PRO (пейволл, квитанции).
- Настройки: трезвый режим, приватность, SOS.

### Admin
- Логин и роли.
- Очередь модерации, карточка объекта, действия.
- Репорты, баны, аудит.
- Фича-флаги и промокоды.

## 19. Текстовые пресеты
- **Темы для разговора**: политика, детство, коты, бывшие, кино, игры, музыка, путешествия, «ни о чём, но душевно».
- **Типы вечера**: «душевно на кухне», «по пиву и спать», «бар-тур», «настолки», «пати на хате», «караоке».
- **Мемные бейджи**: 🥃 «Не закусывает, но держится», 🍺 «Батя на кухне», 🍷 «Душа компании», 🍸 «Слушатель 5/5».
